<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IC Google Sign In</title>
    <link rel="icon" href="img/icon.png" type="image/png" />

    <style>
      @font-face {
        font-family: "Mina";
        src: url("fonts/Mina/Mina-Regular.ttf") format("truetype");
        font-weight: normal;
        font-style: normal;
      }

      html {
        margin: 0;
        padding: 0;
        height: 100%; 
      }
      body {
        font-family: Mina, Arial, sans-serif;
        color: #222;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #f0f0f0;
        font-size: 15px;
        min-height: 100%; 
      }

      .content {
        background-color: white;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        min-height: 400px;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        position: relative;
      }

      .header {
        padding: 15px 20px 7px 20px;
        margin: 0;
        font-size: 25px;
        display: flex;
      }

      .header img {
        margin: 5px;
      }

      hr {
        width: 100%;
        color: #555;
      }

      .body-content {
        flex-grow: 1;
        padding: 50px 20px;
        text-align: center;
      }

      .footer {
        text-align: center;
        margin-top: 20px;
        padding-bottom: 10px;
      }

      .footer a {
        margin: 0 10px;
        padding: 5px 14px;
        border-radius: 5px;
        text-decoration: none;
        color: #555;
        align-content: center;
      }

      .footer a:hover {
        background: #f0f0f0;
      }

      
      @media (min-width: 800px) {
        .content {
          width: 70%;
          max-width: 600px;
          height: auto;
          border-radius: 16px;
          margin: 1em;
        }
      }

      
      @media (max-width: 800px) {
        .content {
          width: 100%;
          height: 100%;
          border-radius: 0;
        }
      }

      button {
        background: linear-gradient(
          135deg,
          #4caf50,
          #2e7d32
        );
        color: white;
        padding: 12px 24px;
        font-size: 16px;
        font-weight: bold;
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition:
          background 0.3s ease,
          box-shadow 0.3s ease,
          transform 0.2s ease;
      }

      button:hover {
        background: linear-gradient(
          135deg,
          #66bb6a,
          #388e3c
        );
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
      }

      button:active {
        background: linear-gradient(
          135deg,
          #388e3c,
          #2e7d32
        ); /* Darker gradient on active */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Reduced shadow on active */
        transform: translateY(0); /* Button returns to normal position */
      }

      button:focus {
        outline: none; /* Remove focus outline */
        box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.3); /* Greenish glow for accessibility */
      }

      /* Styles for the cancel button (now a close button) */
      #cancel {
        position: absolute; /* Position it relative to the header */
        top: 10px;
        right: 10px;
        width: 30px;
        height: 30px;
        border-radius: 50% !important; /* Make it circular */
        background-color: #f0f0f0; /* Light background */
        background-image: none; /* Ensure no gradient */
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        font-size: 18px; /* Size of the 'x' */
        font-weight: bold;
        padding: 10px;
        color: #555; /* Color of the 'x' */
        transition: background-color 0.3s ease;
        border: none;
        box-shadow: none;
        outline: none;
        overflow: hidden;
      }

      #cancel::before {
        content: "×"; /* Multiplication sign for 'x' */
      }

      #cancel:hover {
        background-color: #e0e0e0; /* Slightly darker on hover */
        transform: none; /* Override default button hover transform */
      }

      #cancel:active {
        background-color: #d0d0d0; /* Even darker on active */
        transform: none; /* Override default button active transform */
      }

      #cancel:focus {
        outline: none; /* Remove focus outline */
        box-shadow: 0 0 0 2px rgba(170, 170, 170, 0.3); /* Grayish glow for accessibility */
      }

      .flex-center {
        display: flex;
        justify-content: center;
      }

      ul {
        list-style: none;
        font-family: monospace;
        text-align: left;
      }

      li {
        box-shadow: 0 -1px 2px -2px gray;
        padding: 7px 0px;
      }

      #info {
        padding: 2em 6em;
      }

      .hidden {
        display: none !important;
      }

      /* Spinner CSS */
      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #4CAF50; /* Green color for the spinner */
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 20px auto; /* Center the spinner */
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

    </style>
  </head>
  <body>
    <div class="content">
      <div class="header">
        <img src="img/id.png" alt="logo" height="26px" />
        Identify
        <button id="cancel" class="hidden"></button>
      </div>
      <hr />

      <div class="body-content">
        <div id="identify" class="hidden">
          <div id="spinner" class="hidden spinner"></div> <!-- Added spinner class and removed "Loading..." text -->
          <div id="error" class="hidden"></div>
          <div id="sign-in-btn" class="flex-center">
            <button>Sign in</button>
          </div>
          <div id="app-name" style="margin-top: 1em;">
            Sign in to <strong id="app-origin">-</strong>
          </div>

          <div id="app-scope" style="margin-top: 1em;" class="hidden">
            Whitelisted backend IDs:<br/>
            <strong id="app-targets">-</strong>
          </div>
        </div>

        <div id="demo" class="hidden">
          <div id="provider-buttons" class="flex-center" style="flex-direction: column; gap: 10px;">
            <!-- Buttons will be dynamically added here -->
          </div>
          <button id="demo-logout" class="hidden">Log out</button>
          <div id="demo-build-info" style="padding-top: 6em;">
            <div>Network: <span id="demo-network">-</span></div>
            <div>API endpoint: <span id="demo-api">-</span></div>
            <div>Build time: <span id="demo-build-time">-</span></div>
          </div>
          <!-- User Info Card -->
          <div id="user-card" class="hidden" style="
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            background-color: #fff;
          ">
            <img id="user-icon" src="img/id.png" alt="User Icon" style="
              width: 80px;
              height: 80px;
              border-radius: 50%;
              object-fit: cover;
              margin-bottom: 15px;
              border: 2px solid #4CAF50;
            ">
            <h4 style="margin: 10px 0 5px 0; color: #555;">Signed in as:</h4>
            <h3 id="user-name" style="margin: 0 0 5px 0; color: #333;"></h3>
            <p id="user-email" style="margin: 0 0 10px 0; color: #666; font-size: 0.9em;"></p>
            <p id="user-id" style="margin: 0 0 5px 0; color: #888; font-size: 0.8em; word-break: break-all;"></p>
            <p id="user-principal" style="margin: 0; color: #888; font-size: 0.8em; word-break: break-all;"></p>
            <div id="additional-user-info" style="
              width: 100%;
              text-align: left;
              margin-top: 15px;
              padding-top: 15px;
              border-top: 1px solid #eee;
            ">
              <!-- Additional user info will be populated here -->
            </div>
          </div>
        </div>


        <div id="login-status" style="text-align: left;padding: 1em;font-size: smaller;white-space: pre-wrap;overflow-wrap:break-word;width:fit-content;max-width:100%;margin:auto;"></div>

        <ul id="log"></ul>
      </div>

      <div class="footer">
        <a href="#help" onclick="showInfo('help')">Help</a>
        <a href="#security" onclick="showInfo('security')">Security</a>
        <a href="#about" onclick="showInfo('about')">About</a>
      </div>
      <div id="info" class="hidden">
        <div id="help">
          <h2>Help</h2>

          <h3>Logging In</h3>
          <p>To log in, click the Google Sign-In button. Select your Google account and you'll be redirected to the service you want to use. Each application will create a separate identity for authentication purposes.</p>

          <h3>Why Are Separate Identities Used?</h3>
          <p>Each application uses a unique identity to ensure your activities in one app are independent from others. This keeps your data and actions isolated between applications.</p>

          <h3>Common Issues</h3>
          <ul>
            <li><strong>I can’t log in:</strong> Ensure that you’ve selected the correct Google account and that you have internet access.</li>
            <li><strong>Login expired:</strong> If you're logged out automatically, it may be due to an expired session. Please log in again.</li>
            <li><strong>Permissions issue:</strong> Make sure you’ve granted the necessary permissions when prompted during login.</li>
          </ul>

          <h3>Browser Compatibility</h3>
          <p>This application should work with all modern browsers. Please ensure your browser is up to date for the best performance.</p>

          <h3>Need Further Assistance?</h3>
          <p>If you're experiencing issues or have questions, please contact us at <a href="mailto:support@login.f0i.de">support@login.f0i.de</a>.</p>
        </div>
        <div id="security">
          <h2>Security</h2>

          <h3>Data Protection</h3>
          <p>Your login credentials are securely handled using Google Sign-In. The application does not store any of your passwords or sensitive information. All interactions with the application are conducted over secure, encrypted connections.</p>

          <h3>Separate Identities</h3>
          <p>Each application you access through this platform uses a separate identity, ensuring that no data is shared between apps. This helps keep your information compartmentalized and private.</p>

          <h3>Minimal Data Collection</h3>
          <p>The application only requests the basic information necessary to authenticate your login through Google.
          The canister stores the following data:
            <ul>
              <li>Google account ID</li>
              <li>Email address</li>
              <li>URL of the application requestin authentication (protocol and host name)</li>
              <li>Time of each login</li>
            </ul>
          </p>

          <h3>No Private keys in canister</h3>
          <p>
            The identity delegation is created by leveraging canister signatures.
            These are threshold signatures, so there is no single point of failure to extract the private keys.
            The signatures can only be generated by the specific backend canister.
            Deploying on another canister would result in different identities.
            Canister signatures are also used by Internet-Identity and NFID.
          </p>

          <h3>Automatic Login Management</h3>
          <p>The platform automatically manages your login sessions. You do not need to manually handle your credentials or identities, reducing the risk of mistakes or unauthorized access.</p>

          <h3>No off-chain components</h3>
          <p>
            Token verification is done completely inside the backend canister.
            Google obviously uses theire own infrastructure for token generation and signing, but there are no additional off-chain componentes required for verification and signing in.
          </p>

          <h3>Protection against token reuse</h3>
          <p>
            The messages send to the Internet Computer could be observed by the gateway provider and node provider.
            Therefore the sign in tokens generated by google are linked to the current session key.
            This ensures that an attacker can't reuse the token to sign in with a stolen auth token.
          </p>

          <h2>Risks</h2>

          <h3>Canister Control</h3>
          <p>
            This system is currently controlled by a single developer. However, you can run your own instance or deploy it alongside your dApp. This eliminates the need to trust an additional controller for your specific deployment. Instructions for self-setup are available in the <a href="https://github.com/f0i/identify">f0i/identify GitHub repository</a>. While SNS/DAO could offer decentralization, it introduces new complexities and potential attack vectors.
          </p>

          <h3>Account Takeover</h3>
          <p>
            If your external identity provider account (e.g., Google, Auth0, GitHub, X) is compromised, an attacker could log in as you. If the provider locks your account, you may lose access here too.
          </p>

          <h3>DNS Attacks</h3>
          <p>
            Control over the authentication provider's domain could allow an attacker to inject malicious code or perform Man-in-the-Middle (MITM) attacks during authentication. A service worker offers limited protection.
          </p>

          <h3>HTTP Outcall Vulnerabilities (PKCE Providers like GitHub, X)</h3>
          <p>
            For providers using PKCE (e.g., GitHub, X), the backend makes HTTP outcalls that are not replicated across all nodes. A malicious node could potentially manipulate the authentication response or impersonate the application if a client secret is involved (like with GitHub). You must trust the node providers in the subnet.
          </p>

          <h3>No Security Audit</h3>
          <p>
            The code has not undergone a formal security audit. While critical paths have been reviewed and discussions held with DFINITY team members to address theoretical attacks, a third-party audit would provide more assurance.
          </p>

          <h3>Browser and Network Security</h3>
          <p>
            This system assumes your browser is secure, free from malicious extensions, and that your connection to the external identity provider is secure. It also assumes the external identity providers themselves are secure.
          </p>

          <h3>Data Visibility</h3>
          <p>
            HTTP gateways can read, block, or delay requests. Node providers can read canister state and data during HTTP outcalls. While they cannot modify execution, sensitive information could be exposed.
          </p>
        </div>

        <div id="about">
          <h2>About</h2>
          <p>This application allows users to log in using Google and interact with services on the Internet Computer. Each application receives with a separate identity for authentication, ensuring that user sessions are independent across different apps.</p>

          <h3>Version</h3>
          <p>Current version: <span id="version">-</span></p>

          <h3>Contact</h3>
          <p>This application was developed by <a href="https://cubeworksgmbh.de">CubeWorks GmbH</a>, specialists in embedded software and web/mobile development. CubeWorks provides customized software solutions and expert consulting.</p>

          <p>For inquiries, please contact us at <a href="mailto:info@login.f0i.de">info@login.f0i.de</a> or reach out to CubeWorks directly at <a href="mailto:info@cubeworksgmbh.de">info@cubeworksgmbh.de</a>.</p>
        </div>
      </div>
    </div>

    <script src="./app.js" type="module"></script>
  </body>
</html>
