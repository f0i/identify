import { print; trap } "mo:base/Debug";
import Principal "mo:base/Principal";
import CanisterSignature "../src/backend/CanisterSignature";
import Delegation "../src/backend/Delegation";

print("# CanisterSignature");

print("- get Principal");
let principal = CanisterSignature.toPrincipal(Principal.fromBlob("a"), "asdf");
print(debug_show Principal.toText(principal));
print(debug_show CanisterSignature.DERencodePubKey(Principal.fromBlob("a"), "asdf"));

// AuthRequest from auth client
// '{"kind":"authorize-client","sessionPublicKey":{"0":48,"1":89,"2":48,"3":19,"4":6,"5":7,"6":42,"7":134,"8":72,"9":206,"10":61,"11":2,"12":1,"13":6,"14":8,"15":42,"16":134,"17":72,"18":206,"19":61,"20":3,"21":1,"22":7,"23":3,"24":66,"25":0,"26":4,"27":186,"28":209,"29":14,"30":214,"31":33,"32":26,"33":142,"34":125,"35":235,"36":175,"37":140,"38":189,"39":185,"40":144,"41":210,"42":135,"43":223,"44":167,"45":179,"46":219,"47":126,"48":201,"49":217,"50":235,"51":88,"52":188,"53":223,"54":128,"55":71,"56":177,"57":142,"58":59,"59":74,"60":147,"61":46,"62":73,"63":51,"64":99,"65":121,"66":177,"67":65,"68":116,"69":73,"70":236,"71":62,"72":223,"73":231,"74":107,"75":250,"76":203,"77":41,"78":29,"79":136,"80":9,"81":168,"82":238,"83":91,"84":69,"85":237,"86":190,"87":66,"88":124,"89":67,"90":29},"maxTimeToLive":"28800000000000"}'
// converted to array
// '{"kind":"authorize-client","sessionPublicKey":[0x30,0x59,0x30,0x13,0x06,0x07,0x2a,0x86,0x48,0xce,0x3d,0x02,0x01,0x06,0x08,0x2a,0x86,0x48,0xce,0x3d,0x03,0x01,0x07,0x03,0x42,0x00,0x04,0xba,0xd1,0x0e,0xd6,0x21,0x1a,0x8e,0x7d,0xeb,0xaf,0x8c,0xbd,0xb9,0x90,0xd2,0x87,0xdf,0xa7,0xb3,0xdb,0x7e,0xc9,0xd9,0xeb,0x58,0xbc,0xdf,0x80,0x47,0xb1,0x8e,0x3b,0x4a,0x93,0x2e,0x49,0x33,0x63,0x79,0xb1,0x41,0x74,0x49,0xec,0x3e,0xdf,0xe7,0x6b,0xfa,0xcb,0x29,0x1d,0x88,0x09,0xa8,0xee,0x5b,0x45,0xed,0xbe,0x42,0x7c,0x43,0x1d],"maxTimeToLive":"28800000000000"}'
let sessionKey : [Nat8] = [0x30, 0x59, 0x30, 0x13, 0x06, 0x07, 0x2a, 0x86, 0x48, 0xce, 0x3d, 0x02, 0x01, 0x06, 0x08, 0x2a, 0x86, 0x48, 0xce, 0x3d, 0x03, 0x01, 0x07, 0x03, 0x42, 0x00, 0x04, 0xba, 0xd1, 0x0e, 0xd6, 0x21, 0x1a, 0x8e, 0x7d, 0xeb, 0xaf, 0x8c, 0xbd, 0xb9, 0x90, 0xd2, 0x87, 0xdf, 0xa7, 0xb3, 0xdb, 0x7e, 0xc9, 0xd9, 0xeb, 0x58, 0xbc, 0xdf, 0x80, 0x47, 0xb1, 0x8e, 0x3b, 0x4a, 0x93, 0x2e, 0x49, 0x33, 0x63, 0x79, 0xb1, 0x41, 0x74, 0x49, 0xec, 0x3e, 0xdf, 0xe7, 0x6b, 0xfa, 0xcb, 0x29, 0x1d, 0x88, 0x09, 0xa8, 0xee, 0x5b, 0x45, 0xed, 0xbe, 0x42, 0x7c, 0x43, 0x1d];
let maxTTL = 28800000000000;

let hash = Delegation.getUnsignedHash(sessionKey, 1740052427100650480);

// AuthResponse
// '{"auth":{"kind":"authorize-client-success","delegations":[{"signature":{d9d9f7a26b63657274696669636174655901d7d9d9f7a2647472656583018301830182045820267d108b825149c889227f220ca201138ce621c31c7c3cf174117e7015110bb783024863616e69737465728301820458208bb9b96e5bbb60edba0c75a2ed3ac080b3de988034b264282cfc780886792dbe8301830183024a800000000010000801018301830183024e6365727469666965645f646174618203582098c8ed176ce4a1b13ac7920fc92a879e93ec68b754949d50aef187b83eb090c982045820c00ecead1ae5ee9bba23b06d479d7e09863051b1d486b625299fd41f008500aa82045820ab904cdcb4283837454673807c84ab709963573a1e8359691388617d86c72d9082045820706da3c1f8627a69e02fb1b6ec8cbce91eb2d6f8e512e5a6e1bb0a34132444bb820458201ec69dc70b27c3514e0b221e005a843a89acaadd845f51d2e368bad1eac54b8d8204582006bf7c9a04461adb8e344e1842693ef075b224f5e3f8296ddad9fff3130ec0c383018204582002e4dc52afa46b7d1387518d2ecd42873fd71486d4ecf6986a749b4474a374c383024474696d65820349a292f6b7edc0dd9118697369676e61747572655830b0800df0bc44f4b354657bf2a39d8ee0f207f25626208a43fc6dabc69eaa16aa28bca9e1247417c40760a2fb1a04c8ab64747265658301830243736967830183025820af6d89e15a6b025f514b2916569453afe651a9dfd01764fb73a4f0b6eb670bae83025820e38d261abde2d1e9999476d1aeb9a0d4bc48a7dbffbae959a200daf341e4d60182034082045820b63548b80455380ed3a8af25c49b4e2e1fb6fa36db96d922a7c9d7863975ae2a83024474696d6582034818237606d6fd8922},"delegation":{"pubkey":{"0":48,"1":89,"2":48,"3":19,"4":6,"5":7,"6":42,"7":134,"8":72,"9":206,"10":61,"11":2,"12":1,"13":6,"14":8,"15":42,"16":134,"17":72,"18":206,"19":61,"20":3,"21":1,"22":7,"23":3,"24":66,"25":0,"26":4,"27":186,"28":209,"29":14,"30":214,"31":33,"32":26,"33":142,"34":125,"35":235,"36":175,"37":140,"38":189,"39":185,"40":144,"41":210,"42":135,"43":223,"44":167,"45":179,"46":219,"47":126,"48":201,"49":217,"50":235,"51":88,"52":188,"53":223,"54":128,"55":71,"56":177,"57":142,"58":59,"59":74,"60":147,"61":46,"62":73,"63":51,"64":99,"65":121,"66":177,"67":65,"68":116,"69":73,"70":236,"71":62,"72":223,"73":231,"74":107,"75":250,"76":203,"77":41,"78":29,"79":136,"80":9,"81":168,"82":238,"83":91,"84":69,"85":237,"86":190,"87":66,"88":124,"89":67,"90":29},"targets":[],"expiration":"1739392452843964706"}}],"authnMethod":"gsi","userPublicKey":{"0":48,"1":60,"2":48,"3":12,"4":6,"5":10,"6":43,"7":6,"8":1,"9":4,"10":1,"11":131,"12":184,"13":67,"14":1,"15":2,"16":3,"17":44,"18":0,"19":10,"20":128,"21":0,"22":0,"23":0,"24":0,"25":16,"26":0,"27":8,"28":1,"29":1,"30":175,"31":109,"32":137,"33":225,"34":90,"35":107,"36":2,"37":95,"38":81,"39":75,"40":41,"41":22,"42":86,"43":148,"44":83,"45":175,"46":230,"47":81,"48":169,"49":223,"50":208,"51":23,"52":100,"53":251,"54":115,"55":164,"56":240,"57":182,"58":235,"59":103,"60":11,"61":174}},"emailSet":true}'

// Server returned an error:
//  Code: 400 (Bad Request)
//  Body: Invalid delegation: Invalid canister signature: IcCanisterSignature signature could not be verified: public key 0a80000000001000080101af6d89e15a6b025f514b2916569453afe651a9dfd01764fb73a4f0b6eb670bae, signature d9d9f7a26b63657274696669636174655901d7d9d9f7a2647472656583018301830182045820267d108b825149c889227f220ca201138ce621c31c7c3cf174117e7015110bb783024863616e69737465728301820458208bb9b96e5bbb60edba0c75a2ed3ac080b3de988034b264282cfc780886792dbe8301830183024a800000000010000801018301830183024e6365727469666965645f646174618203582098c8ed176ce4a1b13ac7920fc92a879e93ec68b754949d50aef187b83eb090c982045820c00ecead1ae5ee9bba23b06d479d7e09863051b1d486b625299fd41f008500aa82045820ab904cdcb4283837454673807c84ab709963573a1e8359691388617d86c72d9082045820706da3c1f8627a69e02fb1b6ec8cbce91eb2d6f8e512e5a6e1bb0a34132444bb820458201ec69dc70b27c3514e0b221e005a843a89acaadd845f51d2e368bad1eac54b8d8204582006bf7c9a04461adb8e344e1842693ef075b224f5e3f8296ddad9fff3130ec0c383018204582002e4dc52afa46b7d1387518d2ecd42873fd71486d4ecf6986a749b4474a374c383024474696d65820349a292f6b7edc0dd9118697369676e61747572655830b0800df0bc44f4b354657bf2a39d8ee0f207f25626208a43fc6dabc69eaa16aa28bca9e1247417c40760a2fb1a04c8ab64747265658301830243736967830183025820af6d89e15a6b025f514b2916569453afe651a9dfd01764fb73a4f0b6eb670bae83025820e38d261abde2d1e9999476d1aeb9a0d4bc48a7dbffbae959a200daf341e4d60182034082045820b63548b80455380ed3a8af25c49b4e2e1fb6fa36db96d922a7c9d7863975ae2a83024474696d6582034818237606d6fd8922, error: the signature tree doesn't contain sig/7b29ac50ff2da131984c8c96fd9ae5cbcdee8cc0614b66b64b99279278f9b489/e38d261abde2d1e9999476d1aeb9a0d4bc48a7dbffbae959a200daf341e4d601 path

// --> hash value of delegation is present, just the seed is wrong
