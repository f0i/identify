import { print; trap } "mo:base/Debug";
import Principal "mo:base/Principal";
import CanisterSignature "../src/backend/CanisterSignature";
import Delegation "../src/backend/Delegation";
import Hex "../src/backend/Hex";

print("# CanisterSignature");

print("- get Principal");
let principal = CanisterSignature.toPrincipal(Principal.fromBlob("a"), "asdf");
if (Principal.toText(principal) != Principal.fromText("alhfn-5jl5m-tarlm-awto2-if5am-guxr6-tjcra-4mxbi-olim3-vfxad-3qe")) trap("Unexpected principal for a/asdf");
print(debug_show CanisterSignature.DERencodePubKey(Principal.fromBlob("a"), "asdf"));

let sessionKey : [Nat8] = Hex.toArrayUnsafe("3059301306072a8648ce3d020106082a8648ce3d03010703420004b64297d1ac882642061434543d3c9600f3f59b340f8643ae0a7cd7d3f7378bd8c642cad14c00d13d4cc91487e5630f83a184c34007c019d8ec132f60475c1338");
let expiration = 1740052427100650480;

let hash = Delegation.getUnsignedHash(sessionKey, expiration);
print(debug_show Hex.toText(hash));

// AuthResponse

//{"kind":"authorize-client-success","delegations":[{"signature":"d9d9f7a26b63657274696669636174655905c8d9d9f7a36474726565830183018301820458202001489a8230825799705a8e55bebd28654318aea4141b72662cec4389fc143683024863616e6973746572830182045820cf645eff32b2b8501b033e09af6b77f015a4c2e7c3bf45061c6737b1d5a8ae53830182045820175d8249cfa234f5e82af51ef8e62a9915f853b6ffaf19b47a4b060b3f40dd318301830183018204582020b0244e51acbb9c06fba11de9cacb4cdecbab19585899dd86832eaa4228f5da83018204582014dc496994433658730d71c0b0b49a4504e6467bb596ae0efd96c39925f73c0f8301820458200a98b47e39e7436dfa02ced990c5bdf7a6cbabdc3d077fae81ab4fe37b37e49f830182045820cc002c7f10e2de162ad4c58607745b6264b248dbb9d51a9b5dee17ad8e76700d8301830182045820b85b6f1b6796812dbd9ef33ff6aa09cbe499b87e36e2d9a691096ea458225780830182045820fadbd1ed63eae9acf40ed5659d430c772fb02f15446f5c20943c6f710e46340f83024a0000000000e0866b01018301830183024e6365727469666965645f646174618203582072763d63bf5fcc2f3401a874f71f3dc3a4d924ef920230625ae3bfba3c7246478204582061a752e6d438c0571bf8c0f800c957c6fb4038cbc0e0824d2ac4593cbb992c20820458203b3aaba1f8d89aee0882fb0286845b0349697e754d413106ad12133a44b386bd820458203a27d227ff471c4c9404ba5254f481915ed150590bd212e250488598a8d959ce82045820f83e52463247e5f8e6648db7a6148a69eb0eaabdcdfac9d9df54990ba4e00e4082045820a75c4157726813669f529ddfcf4d3b5206c60738e8fa6f23c114ec73cfc49eb882045820cebb1d738aca6071da9568c7c6fc920a02a65277648b31c862e2798477644c1a8301820458209ebfa3b3872e373cf48cd9c6d3a01db5df62450d0e3ec8b14f0fceebbea350dc83024474696d65820349dae4dceeecc3ef9118697369676e617475726558308393fef0bd40d3b82f4bce934f2989a52101399f9f176123e2c529ecd4025f09fa8395317035c6879c26e56b60258f416a64656c65676174696f6ea2697375626e65745f6964581d2ecc29447b0eef6c241dcfdf7dab077093ccd6a1266be0fe9c9b1276026b636572746966696361746559027dd9d9f7a264747265658301820458206d803b425636fe287138dd5cbcca992c7702e44b564469296a12caaa8693ee918301830182045820b3edf600c78bba19a64627488088cbbad02d00f29061127cdba9cd11426043068302467375626e6574830183018301820458200985315bbe905b7f9336d7064793905b005689f3c9c2a21ad9a31fbe6cdd55998301830183018302581d2ecc29447b0eef6c241dcfdf7dab077093ccd6a1266be0fe9c9b127602830183024f63616e69737465725f72616e6765738203581bd9d9f781824a0000000000e0000001014a0000000000efffff010183024a7075626c69635f6b657982035885308182301d060d2b0601040182dc7c0503010201060c2b0601040182dc7c0503020103610091541cdc7b65c4828286c911602d9438de5649d698b60fc06aec73589395d0bca71746524ed2ff17b2c8da9fbc897f0f07a40b204871b6fe96d45ef10b51d1f1d530d0679a5db82de96929805fa17c737994ebcc2312d2a25bd94747ecf8f34b8204582036977d2eb5781a30f392aa49b68a99e752e3f180e7d6c65dc1155bac272096038204582070ffc8b074ec3f16c63c4ef67bfffa086f81abd71c92ca2bfb58a0fb5f6f9a1882045820ab74f479ced86b9d9505e2ba143c5d3e1c383a8a7e7c68a85a0ec66b45f6b741820458206961ef137c2aee0b0467082ef6d3c12c03e93013b602a4cb6214270e484863f1820458201fa8ba18771baecd4b6799287f6a738b3190d44f6dcb17d82fb8b4e10e7aa2b083024474696d65820349abc5fff7c9fae69018697369676e6174757265583083ac6f293c7db5a88d1b7775fc75b893e8477b6a1faebf1890c9d3270ee1621fe759a1fb2699af07f3093173f5571a3064747265658301830243736967830258207b29ac50ff2da131984c8c96fd9ae5cbcdee8cc0614b66b64b99279278f9b48983025820ee047f4b70668ef30f981077d8ec06688970bc611b49013bcd301106430d752f82034083024474696d658203481823be1e93b91678","delegation":{"pubkey":"3059301306072a8648ce3d020106082a8648ce3d03010703420004b64297d1ac882642061434543d3c9600f3f59b340f8643ae0a7cd7d3f7378bd8c642cad14c00d13d4cc91487e5630f83a184c34007c019d8ec132f60475c1338","targets":[],"expiration":"1739471720606872154"}}],"authnMethod":"gsi","userPublicKey":"303c300c060a2b0601040183b8430102032c000a0000000000e0866b0101af6d89e15a6b025f514b2916569453afe651a9dfd01764fb73a4f0b6eb670bae"}'

//Gateway returned an error:
//Code: 400 ()
//Body: Invalid delegation: Invalid canister signature: IcCanisterSignature signature could not be verified: public key 0a0000000000e0866b0101af6d89e15a6b025f514b2916569453afe651a9dfd01764fb73a4f0b6eb670bae, signature d9d9f7a26b63657274696669636174655905c8d9d9f7a36474726565830183018301820458202001489a8230825799705a8e55bebd28654318aea4141b72662cec4389fc143683024863616e6973746572830182045820cf645eff32b2b8501b033e09af6b77f015a4c2e7c3bf45061c6737b1d5a8ae53830182045820175d8249cfa234f5e82af51ef8e62a9915f853b6ffaf19b47a4b060b3f40dd318301830183018204582020b0244e51acbb9c06fba11de9cacb4cdecbab19585899dd86832eaa4228f5da83018204582014dc496994433658730d71c0b0b49a4504e6467bb596ae0efd96c39925f73c0f8301820458200a98b47e39e7436dfa02ced990c5bdf7a6cbabdc3d077fae81ab4fe37b37e49f830182045820cc002c7f10e2de162ad4c58607745b6264b248dbb9d51a9b5dee17ad8e76700d8301830182045820b85b6f1b6796812dbd9ef33ff6aa09cbe499b87e36e2d9a691096ea458225780830182045820fadbd1ed63eae9acf40ed5659d430c772fb02f15446f5c20943c6f710e46340f83024a0000000000e0866b01018301830183024e6365727469666965645f646174618203582072763d63bf5fcc2f3401a874f71f3dc3a4d924ef920230625ae3bfba3c7246478204582061a752e6d438c0571bf8c0f800c957c6fb4038cbc0e0824d2ac4593cbb992c20820458203b3aaba1f8d89aee0882fb0286845b0349697e754d413106ad12133a44b386bd820458203a27d227ff471c4c9404ba5254f481915ed150590bd212e250488598a8d959ce82045820f83e52463247e5f8e6648db7a6148a69eb0eaabdcdfac9d9df54990ba4e00e4082045820a75c4157726813669f529ddfcf4d3b5206c60738e8fa6f23c114ec73cfc49eb882045820cebb1d738aca6071da9568c7c6fc920a02a65277648b31c862e2798477644c1a8301820458209ebfa3b3872e373cf48cd9c6d3a01db5df62450d0e3ec8b14f0fceebbea350dc83024474696d65820349dae4dceeecc3ef9118697369676e617475726558308393fef0bd40d3b82f4bce934f2989a52101399f9f176123e2c529ecd4025f09fa8395317035c6879c26e56b60258f416a64656c65676174696f6ea2697375626e65745f6964581d2ecc29447b0eef6c241dcfdf7dab077093ccd6a1266be0fe9c9b1276026b636572746966696361746559027dd9d9f7a264747265658301820458206d803b425636fe287138dd5cbcca992c7702e44b564469296a12caaa8693ee918301830182045820b3edf600c78bba19a64627488088cbbad02d00f29061127cdba9cd11426043068302467375626e6574830183018301820458200985315bbe905b7f9336d7064793905b005689f3c9c2a21ad9a31fbe6cdd55998301830183018302581d2ecc29447b0eef6c241dcfdf7dab077093ccd6a1266be0fe9c9b127602830183024f63616e69737465725f72616e6765738203581bd9d9f781824a0000000000e0000001014a0000000000efffff010183024a7075626c69635f6b657982035885308182301d060d2b0601040182dc7c0503010201060c2b0601040182dc7c0503020103610091541cdc7b65c4828286c911602d9438de5649d698b60fc06aec73589395d0bca71746524ed2ff17b2c8da9fbc897f0f07a40b204871b6fe96d45ef10b51d1f1d530d0679a5db82de96929805fa17c737994ebcc2312d2a25bd94747ecf8f34b8204582036977d2eb5781a30f392aa49b68a99e752e3f180e7d6c65dc1155bac272096038204582070ffc8b074ec3f16c63c4ef67bfffa086f81abd71c92ca2bfb58a0fb5f6f9a1882045820ab74f479ced86b9d9505e2ba143c5d3e1c383a8a7e7c68a85a0ec66b45f6b741820458206961ef137c2aee0b0467082ef6d3c12c03e93013b602a4cb6214270e484863f1820458201fa8ba18771baecd4b6799287f6a738b3190d44f6dcb17d82fb8b4e10e7aa2b083024474696d65820349abc5fff7c9fae69018697369676e6174757265583083ac6f293c7db5a88d1b7775fc75b893e8477b6a1faebf1890c9d3270ee1621fe759a1fb2699af07f3093173f5571a3064747265658301830243736967830258207b29ac50ff2da131984c8c96fd9ae5cbcdee8cc0614b66b64b99279278f9b48983025820ee047f4b70668ef30f981077d8ec06688970bc611b49013bcd301106430d752f82034083024474696d658203481823be1e93b91678, error: the signature tree doesn't contain sig/7b29ac50ff2da131984c8c96fd9ae5cbcdee8cc0614b66b64b99279278f9b489/0625fc6e1a76a2653718c4be70fbb601641a585a870f64d517dfe2225a9e5fc9 path

// seed is ok
// Hash is wrong
